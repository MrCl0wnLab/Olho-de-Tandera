<!DOCTYPE html>
<html>
<head>
    <title>Painel de Administração - Olhar de Tandera</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/admin-panel.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/js/socket.io.min.js"></script>
</head>
<body>
    <div class="navbar">
        <h2>Painel de Olhar de Tandera</h2>
        <div>
            <a href="/logout">Logout</a>
        </div>
    </div>

    <div class="admin-panel">
        <div class="tabs">
            <button class="tab-btn active" data-tab="commands">Comandos</button>
            <button class="tab-btn" data-tab="clients">Clientes</button>
            <button class="tab-btn" data-tab="logs">Logs</button>
        </div>

        <div class="tab-content active" id="tab-commands">
            <h2>Enviar Comandos (Olhar)</h2>
            
            <div class="form-group">
                <label>Cliente alvo:</label>
                <select id="target-client" class="form-control">
                    <option value="default">Todos os clientes</option>
                    <!-- Os clientes serão carregados dinamicamente -->
                </select>
            </div>
            
            <div class="form-group">
                <label>Inject JavaScript</label>
                <textarea id="js-command" class="form-control" placeholder="Digite o código JavaScript aqui..."></textarea>
                <div class="buttons">
                    <button onclick="previewCommand('js')" class="btn btn-primary">Preview</button>
                    <button onclick="sendCommand('js')" class="btn btn-success">Executar JS</button>
                </div>
            </div>
            
            <div class="form-group">
                <label>Inject HTML</label>
                <textarea id="html-content" class="form-control" placeholder="Digite o HTML a ser injetado..."></textarea>
                <div class="buttons">
                    <button onclick="previewCommand('html')" class="btn btn-primary">Preview</button>
                    <button onclick="sendCommand('html')" class="btn btn-success">Inject HTML</button>
                </div>
            </div>
            
            <div class="form-group">
                <label>Manipular Elemento</label>
                <input type="text" id="target-element" class="form-control" placeholder="ID do Elemento">
                <select id="action-type" class="form-control">
                    <option value="ADD">Adicionar</option>
                    <option value="REPLACE">Substituir</option>
                    <option value="INSERT_AFTER">Inserir Abaixo</option>
                    <option value="INSERT_BEFORE">Inserir Acima</option>
                </select>
                <textarea id="manipulation-content" class="form-control" placeholder="Conteúdo a ser manipulado..."></textarea>
                <div class="buttons">
                    <button onclick="previewCommand('manipulate')" class="btn btn-primary">Preview</button>
                    <button onclick="sendCommand('manipulate')" class="btn btn-success">Aplicar Manipulação</button>
                </div>
            </div>

            <div class="form-group">
                <label>Visibilidade do Elemento</label>
                <input type="text" id="visibility-element" class="form-control" placeholder="ID do Elemento">
                <div class="form-check">
                    <input type="radio" name="visibility" id="show" value="show" class="form-check-input" checked>
                    <label class="form-check-label" for="show">Mostrar</label>
                </div>
                <div class="form-check">
                    <input type="radio" name="visibility" id="hide" value="hide" class="form-check-input">
                    <label class="form-check-label" for="hide">Ocultar</label>
                </div>
                <button onclick="sendCommand('visibility')" class="btn btn-success">Aplicar Visibilidade</button>
            </div>

            <div class="form-group">
                <label>Manipular Head</label>
                <select id="head-action" class="form-control">
                    <option value="CSS_URL">Adicionar CSS externo (URL)</option>
                    <option value="CSS_INLINE">Adicionar CSS inline</option>
                    <option value="JS_URL">Adicionar Script externo (URL)</option>
                    <option value="JS_INLINE">Adicionar Script inline</option>
                    <option value="META">Adicionar Meta tag</option>
                </select>
                <textarea id="head-content" class="form-control" placeholder="URL ou conteúdo inline..."></textarea>
                <div class="buttons">
                    <button onclick="previewCommand('head')" class="btn btn-primary">Preview</button>
                    <button onclick="sendCommand('head')" class="btn btn-success">Adicionar ao Head</button>
                </div>
            </div>
            
            <div id="preview-panel" style="display: none;">
                <h3>Preview</h3>
                <div id="preview-content" class="preview-container"></div>
            </div>
            
            <div id="status">Pronto para enviar comandos</div>
        </div>
        
        <div class="tab-content" id="tab-clients">
            <h2>Clientes Conectados</h2>
            <button onclick="refreshClients()" class="btn btn-primary">Atualizar</button>
            
            <div id="client-list">
                <p>Carregando clientes...</p>
            </div>
        </div>
        
        <div class="tab-content" id="tab-logs">
            <h2>Logs de Comandos</h2>
            <button onclick="refreshLogs()" class="btn btn-primary">Atualizar</button>
            <div id="logs-list">
                <p>Carregando logs...</p>
            </div>
        </div>
    </div>
    
    <style>
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab-btn {
            padding: 10px 20px;
            background-color: #f8f8f8;
            border: none;
            border-bottom: 3px solid transparent;
            margin-right: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .tab-btn.active {
            border-bottom: 3px solid #007bff;
            background-color: #fff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .preview-container {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f8f8f8;
            margin-bottom: 20px;
            max-height: 300px;
            overflow: auto;
        }
        
        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .client-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .client-info {
            flex-grow: 1;
        }
        
        .client-actions {
            display: flex;
            gap: 5px;
        }
        
        .form-group {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        
        label {
            font-weight: bold;
            margin-bottom: 8px;
            display: block;
        }
        
        textarea, .form-control {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        textarea {
            min-height: 100px;
            font-family: monospace;
        }
    </style>
    
    <script>
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                // Deactivate all tabs
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                // Activate selected tab
                button.classList.add('active');
                document.getElementById('tab-' + button.dataset.tab).classList.add('active');
                
                // Load content based on tab
                if (button.dataset.tab === 'clients') {
                    refreshClients();
                } else if (button.dataset.tab === 'logs') {
                    refreshLogs();
                }
            });
        });

        // Função para enviar comando
        function sendCommand(type) {
            const statusElement = document.getElementById('status');
            const clientId = document.getElementById('target-client').value;
            
            try {
                let data = { 
                    type,
                    client_id: clientId
                };
                
                switch(type) {
                    case 'js':
                        data.content = document.getElementById('js-command').value;
                        if (!data.content.trim()) {
                            throw new Error("O código JavaScript não pode estar vazio");
                        }
                        break;
                        
                    case 'html':
                        data.content = document.getElementById('html-content').value;
                        if (!data.content.trim()) {
                            throw new Error("O conteúdo HTML não pode estar vazio");
                        }
                        break;
                        
                    case 'manipulate':
                        data.target_id = document.getElementById('target-element').value;
                        data.action = document.getElementById('action-type').value;
                        data.content = document.getElementById('manipulation-content').value;
                        if (!data.target_id.trim()) {
                            throw new Error("ID do elemento é obrigatório");
                        }
                        if (!data.content.trim()) {
                            throw new Error("O conteúdo a ser manipulado não pode estar vazio");
                        }
                        break;
                        
                    case 'visibility':
                        data.target_id = document.getElementById('visibility-element').value;
                        const radioChecked = document.querySelector('input[name="visibility"]:checked');
                        if (!radioChecked) {
                            throw new Error("Selecione uma opção de visibilidade");
                        }
                        data.content = radioChecked.value;
                        if (!data.target_id.trim()) {
                            throw new Error("ID do elemento é obrigatório");
                        }
                        break;

                    case 'head':
                        data.action = document.getElementById('head-action').value;
                        data.content = document.getElementById('head-content').value;
                        if (!data.content.trim()) {
                            throw new Error("O conteúdo para o head não pode estar vazio");
                        }
                        break;
                }
                
                statusElement.textContent = `Enviando comando ${type}...`;
                statusElement.className = '';
                
                fetch('/admin/set_command', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        statusElement.textContent = `Comando enviado com sucesso às ${new Date().toLocaleTimeString()}`;
                        statusElement.className = 'connected';
                    } else {
                        throw new Error(data.error || "Erro no servidor ao processar comando");
                    }
                })
                .catch(error => {
                    statusElement.textContent = `Erro ao enviar comando: ${error.message}`;
                    statusElement.className = 'error';
                });
            } catch (error) {
                statusElement.textContent = `Erro: ${error.message}`;
                statusElement.className = 'error';
            }
        }
        
        // Função para visualizar comando
        function previewCommand(type) {
            const previewPanel = document.getElementById('preview-panel');
            const previewContent = document.getElementById('preview-content');
            
            try {
                let content = '';
                
                switch(type) {
                    case 'js':
                        const jsCode = document.getElementById('js-command').value;
                        if (!jsCode.trim()) throw new Error("Nenhum código para visualizar");
                        content = `<pre>${escapeHtml(jsCode)}</pre>`;
                        break;
                        
                    case 'html':
                        const htmlCode = document.getElementById('html-content').value;
                        if (!htmlCode.trim()) throw new Error("Nenhum HTML para visualizar");
                        content = `
                            <div>
                                <strong>Código HTML:</strong>
                                <pre>${escapeHtml(htmlCode)}</pre>
                                <strong>Visualização:</strong>
                                <div class="preview-render">${htmlCode}</div>
                            </div>
                        `;
                        break;
                        
                    case 'manipulate':
                        const targetElement = document.getElementById('target-element').value;
                        const actionType = document.getElementById('action-type').value;
                        const manipContent = document.getElementById('manipulation-content').value;
                        
                        if (!targetElement.trim() || !manipContent.trim()) {
                            throw new Error("ID do elemento e conteúdo são obrigatórios");
                        }
                        
                        content = `
                            <div>
                                <p><strong>Elemento alvo:</strong> #${escapeHtml(targetElement)}</p>
                                <p><strong>Ação:</strong> ${actionType}</p>
                                <p><strong>Conteúdo:</strong></p>
                                <pre>${escapeHtml(manipContent)}</pre>
                                <strong>Visualização:</strong>
                                <div class="preview-render">${manipContent}</div>
                            </div>
                        `;
                        break;
                        
                    case 'head':
                        const headAction = document.getElementById('head-action').value;
                        const headContent = document.getElementById('head-content').value;
                        
                        if (!headContent.trim()) {
                            throw new Error("Conteúdo é obrigatório");
                        }
                        
                        content = `
                            <div>
                                <p><strong>Tipo:</strong> ${headAction}</p>
                                <p><strong>Conteúdo:</strong></p>
                                <pre>${escapeHtml(headContent)}</pre>
                            </div>
                        `;
                        break;
                }
                
                previewContent.innerHTML = content;
                previewPanel.style.display = 'block';
                
                // Rolar para o preview
                previewPanel.scrollIntoView({behavior: "smooth"});
            } catch (error) {
                alert("Erro de preview: " + error.message);
            }
        }
        
        // Escapar HTML para exibição segura
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Carregar lista de clientes
        function refreshClients() {
            const clientList = document.getElementById('client-list');
            clientList.innerHTML = '<p>Carregando clientes...</p>';
            
            fetch('/admin/clients')
                .then(response => response.json())
                .then(data => {
                    if (data.clients && data.clients.length > 0) {
                        const clientsHtml = data.clients.map(client => `
                            <div class="client-card ${client.active ? 'client-online' : 'client-offline'} ${client.websocket ? 'client-websocket' : ''}">
                                <div class="client-info">
                                    <p><strong>ID:</strong> ${client.id}</p>
                                    <p><strong>Status:</strong> ${client.active ? 'Online' : 'Offline'} ${client.websocket ? '(WebSocket)' : '(Polling)'}</p>
                                    <p><strong>Última atividade:</strong> ${new Date(client.last_seen).toLocaleString()}</p>
                                </div>
                                <div class="client-actions">
                                    <button onclick="targetClient('${client.id}')" class="btn btn-primary">Selecionar</button>
                                    <button onclick="removeClient('${client.id}')" class="btn btn-danger">Remover</button>
                                </div>
                            </div>
                        `).join('');
                        
                        clientList.innerHTML = clientsHtml;
                        
                        // Atualizar dropdown de clientes
                        updateClientDropdown(data.clients);
                    } else {
                        clientList.innerHTML = '<p>Nenhum cliente encontrado.</p>';
                    }
                })
                .catch(error => {
                    clientList.innerHTML = `<p>Erro ao carregar clientes: ${error.message}</p>`;
                });
        }
        
        // Atualizar dropdown de seleção de cliente
        function updateClientDropdown(clients) {
            const dropdown = document.getElementById('target-client');
            
            // Manter a opção default
            const defaultOption = dropdown.options[0];
            dropdown.innerHTML = '';
            dropdown.appendChild(defaultOption);
            
            // Adicionar clientes
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = `Cliente: ${client.id.substring(0, 8)}... ${client.active ? '(online)' : '(offline)'} ${client.websocket ? '⚡' : ''}`;
                dropdown.appendChild(option);
            });
        }
        
        // Selecionar cliente para target
        function targetClient(clientId) {
            document.getElementById('target-client').value = clientId;
            
            // Mudar para a aba de comandos
            document.querySelector('.tab-btn[data-tab="commands"]').click();
            
            document.getElementById('status').textContent = `Cliente ${clientId.substring(0, 8)}... selecionado`;
        }
        
        // Remover cliente
        function removeClient(clientId) {
            if (confirm(`Tem certeza que deseja remover o cliente ${clientId}?`)) {
                fetch(`/admin/clients/${clientId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        refreshClients();
                    } else {
                        alert(`Erro ao remover cliente: ${data.error}`);
                    }
                })
                .catch(error => {
                    alert(`Erro ao remover cliente: ${error.message}`);
                });
            }
        }
        
        // Carregar logs
        function refreshLogs() {
            const logsList = document.getElementById('logs-list');
            logsList.innerHTML = '<p>Carregando logs...</p>';
            
            fetch('/admin/logs')
                .then(response => response.json())
                .then(data => {
                    if (data.logs && data.logs.length > 0) {
                        const logsHtml = data.logs.map(log => `
                            <div class="log-entry">
                                <p><strong>Data/Hora:</strong> ${new Date(log.timestamp).toLocaleString()}</p>
                                <p><strong>Cliente:</strong> ${log.client_id}</p>
                                <p><strong>Tipo:</strong> ${log.type}</p>
                                <p><strong>Comando:</strong></p>
                                <pre>${escapeHtml(log.command)}</pre>
                            </div>
                        `).join('<hr>');
                        
                        logsList.innerHTML = logsHtml;
                    } else {
                        logsList.innerHTML = '<p>Nenhum log encontrado.</p>';
                    }
                })
                .catch(error => {
                    logsList.innerHTML = `<p>Erro ao carregar logs: ${error.message}</p>`;
                });
        }
        
        // Conexão WebSocket para Admin
        let socket = null;
        
        function initWebSocket() {
            try {
                // Inicializar Socket.IO
                socket = io();
                
                // Evento de conexão
                socket.on('connect', function() {
                    console.log('Admin conectado via WebSocket');
                    document.getElementById('connection-type').textContent = 'Modo: WebSocket';
                    document.getElementById('connection-type').className = 'badge websocket';
                    
                    // Administrador se junta à sala admin
                    socket.emit('join_admin');
                });
                
                // Receber confirmação de admin
                socket.on('admin_joined', function(data) {
                    if (data.success) {
                        console.log('Admin entrou na sala de administração');
                    } else {
                        console.error('Erro ao entrar na sala de administração:', data.error);
                    }
                });
                
                // Atualização de clientes em tempo real
                socket.on('client_update', function(data) {
                    console.log('Atualização de cliente em tempo real:', data);
                    refreshClients(); // Atualizar lista de clientes
                });
                
                // Evento de desconexão
                socket.on('disconnect', function() {
                    console.log('Admin desconectado do WebSocket');
                    document.getElementById('connection-type').textContent = 'Modo: Polling';
                    document.getElementById('connection-type').className = 'badge polling';
                });
                
                // Reconexão
                socket.on('reconnect', function() {
                    console.log('Admin reconectado via WebSocket');
                    socket.emit('join_admin');
                });
            } catch (e) {
                console.error('Erro ao inicializar WebSocket:', e);
                document.getElementById('connection-type').textContent = 'Modo: Polling (Erro WebSocket)';
                document.getElementById('connection-type').className = 'badge polling';
            }
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            refreshClients();
            initWebSocket();
        });
    </script>
</body>
</html>
